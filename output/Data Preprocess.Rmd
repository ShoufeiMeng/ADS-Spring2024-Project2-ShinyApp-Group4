---
title: "Data Preprocess"
output: html_document
date: "2024-02-15"
---

Set gloabl options

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='figs/',
                      echo=T, warning=FALSE, message=FALSE)
```

Load the data manipulation libraries

```{r}
if (!require("DT")) install.packages('DT')
if (!require("dtplyr")) install.packages('dtplyr')
if (!require("lubridate")) install.packages('lubridate')
if (!require("ggmap")) install.packages('ggmap')
if (!require("choroplethrZip")) {
  # install.packages("devtools")
  library(devtools)
  install_github('arilamstein/choroplethrZip@v1.5.0')}

library(dtplyr)
library(dplyr)
library(DT)
library(lubridate)
```

Install shiny

```{r}
if (!require("shiny")) install.packages("shiny")
library(shiny)
runExample("01_hello")
```

Load Data

```{r read data}
v1 <- read.csv("D:/JupyterScripts/Github/ADS-Spring2024-Project2-ShinyApp-Group4/data/FemaWebDisasterDeclarations.csv")
v2 <- read.csv("D:/JupyterScripts/Github/ADS-Spring2024-Project2-ShinyApp-Group4/data/DisasterDeclarationsSummaries.csv")
v3 <- read.csv("D:/JupyterScripts/Github/ADS-Spring2024-Project2-ShinyApp-Group4/data/PublicAssistanceApplicantsProgramDeliveries.csv")

```

Inspect the Data

```{r}
# View the first few rows of the data
head(v1)

# Summary statistics for each column
summary(v1)

# Structure of the data
str(v1)
```

Handle Missing Values

```{r}
library(dplyr)
library(tidyverse)
na_count <- v1 %>%
  summarise_all(~sum(is.na(.)))

print(na_count)

v1_sel <- v1 %>%
  select(disasterName, stateCode, declarationType, disasterNumber)

v2_sel <- v2 %>% 
  select(state, disasterNumber, incidentType,incidentBeginDate,incidentEndDate, designatedArea)

v3_sel <- v3 %>% 
  select(currentProjectCost, disasterNumber)





library(dplyr)
combined <- inner_join(v1_sel, v2_sel, by = "disasterNumber")
combined_df<- inner_join(combined, v3_sel, by = "disasterNumber")



```

Combine Disaster Type

```{r}
combined1 <- combined_df %>%
  mutate(DisasterCategory = case_when(
    incidentType %in% c("Dam/Levee Break", "Earthquake","Fire","Flood", "Freezing", "Tsunami", "Volcanic Eruption", "Mud/Landslide", "Drought") ~ "Natural Disasters",
    incidentType %in% c("Chemical", "Toxic Substances", "Human Cause", "Terrorist") ~ "Human-caused Disasters",
    incidentType %in% c("Coastal Storm","Hurricane","Tropical Storm","Severe Storm", "Snowstorm", "Winter Storm", "Severe Ice Storm", "Tornado", "Typhoon") ~ "Severe Weather",
    incidentType %in% c("Biological") ~ "Biological",
    TRUE ~ "Others"  # Default category for anything else
  ))

head(combined1,5)
```

Years for Map

```{r}
combined2 <- combined1 %>%
  mutate(
    incidentBeginMonth = format(ymd_hms(incidentBeginDate), "%Y-%m")
  )


combined2$Year <- sub("-.*", "", combined2$incidentBeginMonth)

#To sort the data frame in ascending order of year
combined2 <- combined2 %>%
  mutate(Year = as.numeric(Year)) %>%
  arrange(Year)

# Calculate the occurrence counts for each state and disaster type in each year
disaster_counts <- combined2 %>%
  group_by(state = stateCode, DisasterCategory,Year) %>%
  summarise(frequency = n()) 
head(disaster_counts)

# Calculate the cost of disaster for each state and disaster type in each year
head(combined2)
disaster_costs <- combined2 %>%
  group_by(stateCode, DisasterCategory,Year) %>%
  summarise(TotalProjectCost = sum(currentProjectCost, na.rm = TRUE), .groups = "drop")
head(disaster_costs,5)
```

Time Series

```{r}
combined3 <- combined %>%
  mutate(DisasterCategory = case_when(
    incidentType %in% c("Dam/Levee Break", "Earthquake","Fire","Flood", "Freezing", "Tsunami", "Volcanic Eruption", "Mud/Landslide", "Drought") ~ "Natural Disasters",
    incidentType %in% c("Chemical", "Toxic Substances", "Human Cause", "Terrorist") ~ "Human-caused Disasters",
    incidentType %in% c("Coastal Storm","Hurricane","Tropical Storm","Severe Storm", "Snowstorm", "Winter Storm", "Severe Ice Storm", "Tornado", "Typhoon") ~ "Severe Weather",
    incidentType %in% c("Biological") ~ "Biological",
    TRUE ~ "Others"  # Default category for anything else
  ))

combined4 <- combined3 %>%
  mutate(
    incidentBeginMonth = format(ymd_hms(incidentBeginDate), "%Y-%m")
  )


```

```{r}
monthly_disasters <- combined4 %>%
  group_by(incidentBeginMonth) %>%
  summarise(NumberOfDisasters = n())


print(monthly_disasters)

monthly_disasters$incidentBeginMonth <- as.Date(paste0(monthly_disasters$incidentBeginMonth, "-01"))
start_year <- as.numeric(format(min(monthly_disasters$incidentBeginMonth), "%Y"))
start_month <- as.numeric(format(min(monthly_disasters$incidentBeginMonth), "%m"))

plot(NumberOfDisasters ~ incidentBeginMonth, data = monthly_disasters, type = "l")

```

Calculate the occurrence counts for each state and disaster type

```{r}
disaster_counts_ts <- combined4 %>%
  group_by(state = stateCode, DisasterCategory) %>%
  summarise(frequency = n())

```

Time Series

```{r}
monthly_disasters <- combined4 %>%
  group_by(incidentBeginMonth, state) %>%
  summarise(NumberOfDisasters = n())

table(monthly_disasters$state)
```

Plots
```{r}
par(mfrow = c(5,1))
plot(disaster_ts, main = "Monthly Disaster Count", xlab = "Month", ylab = "Disaster Count")
# AR Model Plot
plot(forecast(ar_model), main = "AR Model Forecast")

# MA Model Plot
plot(forecast(ma_model), main = "MA Model Forecast")

# ARMA Model Plot
plot(forecast(arma_model), main = "ARMA Model Forecast")

# ARIMA Model Plot
plot(forecast(arima_model), main = "ARIMA Model Forecast")
```

```{r}
#may not be used 
#install.packages("leaflet")
library(shiny)
library(leaflet)
library(ggplot2)
library(dplyr)
library(forecast)

shinyApp(
ui <- fluidPage(
  titlePanel("Disaster Analysis Dashboard"),
  tabsetPanel(

    tabPanel('Statistical Analysis',
             sidebarPanel(selectInput("year", "Choose a Year:", choices = sort(unique(year(combined$incidentBeginDate)), decreasing = TRUE),2023),
                          selectInput("disasterType", "Choose a Disaster Type:", choices = unique(combined$incidentType))
    ),
    mainPanel(
      plotOutput("stat_hist")
    )
  ),

    tabPanel("ARIMA",
            sidebarPanel(selectInput("state", "Choose a State:",choices=unique(monthly_disasters$state)),
                         sliderInput("AR", "Choose p:",0,10,0),
                         sliderInput("I", "Choose d:",0,10,0),
                         sliderInput("MA", "Choose q:",0,10,0)),
            mainPanel(plotOutput("acf_plot"),
                      plotOutput("pacf_plot"),
                      verbatimTextOutput("arima_summary"),
                      plotOutput("forecast_plot")
  )
    ),
    tabPanel("MAP",


    )
  )
),

server <- function(input, output, session) {
  # Statistical Analysis
  filtered_data <- reactive({
    combined %>%
      filter(year(incidentBeginDate) == input$year,
             incidentType == input$disasterType)
  })
  
  # 在UI中显示直方图
  output$stat_hist <- renderPlot({
    # 从过滤后的数据中提取州和发生次数列
    states <- filtered_data()$state
    occurrences <- sort(table(states),decreasing = TRUE)
    
    # 绘制直方图
    barplot(occurrences, main = "Disaster Occurrences by State", xlab = "State", ylab = "Number of Occurrences", col = "lightblue", border = "black")
  })
  
  # Map output
  output$disasterMap <- renderLeaflet({
    # Use your filtered_data() to create the map
  })
  
  # Trend plot output
  output$trendPlot <- renderPlot({
    # Use your filtered_data() to create the plot
  })
  #ARIMA
  disasters_filtered=reactive({
  filtered_data = filter(monthly_disasters, state == input$state)
  filtered_data = arrange(filtered_data, incidentBeginMonth)
  filtered_data$incidentBeginMonth = as.Date(paste0(filtered_data$incidentBeginMonth, "-01"))
  filtered_data
  })
  disaster_ts=reactive({
    start_year = as.numeric(format(min(disasters_filtered()$incidentBeginMonth), "%Y"))
    start_month = as.numeric(format(min(disasters_filtered()$incidentBeginMonth), "%m"))
    tem=ts(disasters_filtered()$NumberOfDisasters, start = c(start_year, start_month), frequency = 12)
    return(tem)
  })
    
  output$arima_summary = renderPrint({
    arima(disaster_ts(),c(input$AR,input$I,input$MA))
  })
  output$forecast_plot = renderPlot({
    fit=arima(disaster_ts(),c(input$AR,input$I,input$MA))
    forecast_values <- forecast(fit, h=10)
    plot(forecast_values, main="ARIMA Forecast", xlab="Time", ylab="Value")
  })
  output$acf_plot = renderPlot({
    acf(disaster_ts(),main='ACF')
  })
  output$pacf_plot = renderPlot({
    pacf(disaster_ts(),main='PACF')
  })
}
)

```
